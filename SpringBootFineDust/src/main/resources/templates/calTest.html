<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>달력과 미세먼지</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<style>
.day-circle {
	width: 30px;
	height: 30px;
	line-height: 30px;
	border-radius: 50%;
	margin: auto;
	cursor: pointer;
}

.calendar-box {
	border: 1px solid #ddd;
	padding: 15px;
	border-radius: 8px;
}

.schedule-card {
	border: 1px solid #ccc;
	border-radius: 10px;
}
</style>
</head>
<body>
	<div class="container my-5">
		<div class="row">
			<!-- 달력 영역 -->
			<div class="col-md-8 mb-4">
				<div class="calendar-box">
					<h4 class="d-flex align-items-center justify-content-between">
						<div>
							<button class="btn btn-outline-secondary btn-sm me-2"
								onclick="changeMonth(-1)">←</button>
							<span id="month-year"></span>
							<button class="btn btn-outline-secondary btn-sm ms-2"
								onclick="changeMonth(1)">→</button>
						</div>
					</h4>
					<table class="table table-bordered mt-3 text-center">
						<thead>
							<tr>
								<th class="text-danger">일</th>
								<th>월</th>
								<th>화</th>
								<th>수</th>
								<th>목</th>
								<th>금</th>
								<th class="text-primary">토</th>
							</tr>
						</thead>
						<tbody id="calendar-body"></tbody>
					</table>
				</div>
			</div>

			<!-- 📌 조회 + Collapse -->
			<div class="collapse" id="dustCard">
				<div class="col-md-4">
					<div class="card schedule-card">
						<div
							class="card-header d-flex justify-content-between align-items-center">
							<span>미세먼지 정보 조회</span>
						</div>
						<div class="card-body" id="exam-schedule">
							<p>날짜를 클릭하면 아래에 미세먼지 정보가 표시됩니다.</p>
							<!-- Collapse 영역 -->
							<div class="accordion" id="dustAccordion">
								<div class="accordion-item">
									<h2 class="accordion-header" id="headingDust">
										<button class="accordion-button collapsed" type="button"
											data-bs-toggle="collapse" data-bs-target="#collapseDust"
											aria-expanded="false" aria-controls="collapseDust">
											<span id="collapse-title">미세먼지 평균 정보</span>
										</button>
									</h2>
									<div id="collapseDust" class="accordion-collapse collapse"
										aria-labelledby="headingDust">
										<div class="accordion-body" id="dust-detail">
											<p >날짜를 선택하면 오전/오후 평균이 표시됩니다.</p>
										</div>
									</div>
								</div>
							</div>

							<!-- 끝 -->
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Bootstrap JS -->
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<script>
    const calendarBody = document.getElementById("calendar-body");
    const monthYear = document.getElementById("month-year");
    let currentDate = new Date();

    
    

    function pad(num) {
      return String(num).padStart(2, "0");
    }
//달력 손대지말것
    function renderCalendar(date) {
      calendarBody.innerHTML = "";
      const year = date.getFullYear();
      const month = date.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();
      monthYear.textContent = `${year}년 ${month + 1}월`;

      let day = 1;
      for (let i = 0; i < 6; i++) {
        const row = document.createElement("tr");
        for (let j = 0; j < 7; j++) {
          const cell = document.createElement("td"); //2중반복문으로 행 열 생성 

          if (i === 0 && j < firstDay || day > lastDate) {
            cell.innerHTML = "";
          } else {
            const thisDate = new Date(year, month, day);
            const dateStr = `${year}-${pad(month + 1)}-${pad(day)}`;
            const dayCircle = document.createElement("div");
            dayCircle.classList.add("day-circle");
            dayCircle.textContent = day;

            function getWeekdayName(dateStr) {
            	  const date = new Date(dateStr);
            	  const days = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
            	  return days[date.getDay()];
            	}   
            // 날짜 클릭 이벤트
            dayCircle.addEventListener("click", () => {
            	//const dateStr = `${year}-${pad(month+1)}-${pad(day)}`; // 클릭된 날짜
            	
            	const weekday = getWeekdayName(dateStr);
            	  // 1. 날짜 클릭 시 collapse 카드 열기
            	  console.log("클릭은됨 ㅇㅇㅇ")
            	fetch(`/dust-data/${dateStr}`)	//선택한 날짜 데이터 요청
            	  .then(res => res.json())
            	  .then(data => {console.log(data)  // 받아옴 ㅇㅇ
            	    const title = document.getElementById("collapse-title");
            	    const detail = document.getElementById("dust-detail");
					
            	    title.textContent = `${dateStr} (${weekday}) 미세먼지 평균 정보`;
            	    console.log("error")

            	   if (!data || data.length === 0) {
        			detail.innerHTML = `<p>데이터가 없습니다.</p>`;
       				 return;
       				 
     				 }
                    const dustCard = document.getElementById("dustCard");
                    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(dustCard);
                    bsCollapse.show();  
                    // ㄴ 드랍다운보여줌 
                    detail.innerHTML = `<ul><li><strong>오전 평균:</strong> PM1: ${data[0].amAvgPm1 ?? 'N/A'}, PM2.5: ${data[0].amAvgPm25 ?? 'N/A'}, PM10: ${data[0].amAvgPm10 ?? 'N/A'}</li><li><strong>오후 평균:</strong> PM1: ${data[0].pmAvgPm1 ?? 'N/A'}, PM2.5: ${data[0].pmAvgPm25 ?? 'N/A'}, PM10: ${data[0].pmAvgPm10 ?? 'N/A'}</li></ul>`;
                    return;
					//period = HOUR(time_hms) <12 am or pm
            	    

            	      
            	    });
            	});

         

            cell.appendChild(dayCircle);
            day++;
          }

          row.appendChild(cell);
        }
        calendarBody.appendChild(row);
        if (day > lastDate) break;
      }
    }

    function average(arr) {
      return (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(2);
    }
	// 달(month) 전환 
    function changeMonth(offset) {
      currentDate.setMonth(currentDate.getMonth() + offset);
      renderCalendar(currentDate);
    }

    renderCalendar(currentDate);
  </script>
</body>
</html>
