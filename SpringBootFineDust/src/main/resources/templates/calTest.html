<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“… ë‹¬ë ¥ ë° ì¼ì •</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    table {
      width: 100%;
      text-align: center;
    }
    .day-circle {
      width: 30px;
      height: 30px;
      line-height: 30px;
      border-radius: 50%;
      margin: auto;
    }
    .calendar-box {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
    }
    .schedule-card {
      border: 1px solid #ccc;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div class="container mb-5">
    <div class="row">
      <!-- ë‹¬ë ¥ ì˜ì—­ -->
      <div class="col-md-8 mb-4">
        <div class="calendar-box">
          <h4 class="d-flex align-items-center justify-content-between">
            <div>
              <button class="btn btn-outline-secondary btn-sm me-2" onclick="changeMonth(-1)">â†</button>
              <span id="month-year"></span>
              <button class="btn btn-outline-secondary btn-sm ms-2" onclick="changeMonth(1)">â†’</button>
            </div>
            <button class="btn btn-primary rounded-pill px-3" type="button" id="check-attendance">ì¶œì„</button>
          </h4>
          <table class="table table-bordered mt-3">
            <thead>
              <tr>
                <th style="color: red;">ì¼</th>
                <th>ì›”</th>
                <th>í™”</th>
                <th>ìˆ˜</th>
                <th>ëª©</th>
                <th>ê¸ˆ</th>
                <th>í† </th>
              </tr>
            </thead>
            <tbody id="calendar-body"></tbody>
          </table>
        </div>
      </div>

      <!-- ì ‘ìˆ˜ ì¼ì • ì˜ì—­ -->
      <div class="col-md-4">
        <div class="card schedule-card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>ğŸ“Œ ì ‘ìˆ˜</span>
          </div>
          <div class="card-body" id="exam-schedule">
            <!-- ë™ì  ì‚½ì… ì˜ˆì • -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Thymeleafë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ì„œë²„ì—ì„œ ë Œë”ë§ ì‹œ ì•„ë˜ ë°°ì—´ì„ ë™ì ìœ¼ë¡œ ì±„ì›€
    const examPeriods = [
      {
        title: "ì •ë³´ì²˜ë¦¬ê¸°ì‚¬",
        appStd: "2025-06-10",
        appEd: "2025-06-13"
      },
      {
        title: "ì „ê¸°ê¸°ì‚¬",
        appStd: "2025-06-18",
        appEd: "2025-06-20"
      }
    ];

    const examDates = [];
    const examScheduleEl = document.getElementById("exam-schedule");

    examPeriods.forEach(exam => {
      const start = new Date(exam.appStd);
      const end = new Date(exam.appEd);
      let d = new Date(start);

      // i íƒœê·¸ë¡œ ì „í™˜í•´ì„œ -> ìš”ì•½ ì¹´ë“œ í‘œì‹œ
      const examEl = document.createElement("div");
      const titleEl = document.createElement("h5");
      titleEl.textContent = exam.title;
      examEl.appendChild(titleEl);

      const rangeEl = document.createElement("p");
      rangeEl.textContent = `${exam.appStd} ~ ${exam.appEd}`;
      examEl.appendChild(rangeEl);

      examScheduleEl.appendChild(examEl);

      // ë‚ ì§œ ë°°ì—´ ìƒì„±
      while (d <= end) {
        const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        examDates.push({ date: dateStr, title: exam.title });
        d.setDate(d.getDate() + 1);
      }
    });

    const calendarBody = document.getElementById("calendar-body");
    const monthYear = document.getElementById("month-year");
    const checkAttendanceBtn = document.getElementById("check-attendance");
    let currentDate = new Date();

    function pad(num) {
      return String(num).padStart(2, '0');
    }

    function renderCalendar(date) {
      calendarBody.innerHTML = "";
      const year = date.getFullYear();
      const month = date.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();

      monthYear.textContent = `ğŸ“… ${year}ë…„ ${month + 1}ì›”`;

      let day = 1;
      for (let i = 0; i < 6; i++) {
        const row = document.createElement("tr");
        for (let j = 0; j < 7; j++) {
          const cell = document.createElement("td");

          if (i === 0 && j < firstDay || day > lastDate) {
            cell.innerHTML = "";
          } else {
            const thisDate = new Date(year, month, day);
            const dateStr = `${year}-${pad(month + 1)}-${pad(day)}`;
            const dayCircle = document.createElement("div");
            dayCircle.classList.add("day-circle");
            dayCircle.textContent = day;
            dayCircle.addEventListener("click", () => {
            	  const data = dustData[dateStr];

            	  const title = document.getElementById("collapse-title");
            	  const detail = document.getElementById("dust-detail");

            	  if (data) {
            	    const am = data.slice(0, 12);
            	    const pm = data.slice(12, 24);
            	    const avg = arr => arr.reduce((a, b) => a + b, 0) / arr.length;

            	    const amAvg = avg(am).toFixed(2);
            	    const pmAvg = avg(pm).toFixed(2);

            	    title.textContent = `ğŸ“… ${dateStr} ë¯¸ì„¸ë¨¼ì§€ í‰ê· `;
            	    detail.innerHTML = `
            	      <p><strong>ì˜¤ì „ í‰ê· :</strong> ${amAvg} Âµg/mÂ³</p>
            	      <p><strong>ì˜¤í›„ í‰ê· :</strong> ${pmAvg} Âµg/mÂ³</p>
            	    `;
            	  } else {
            	    title.textContent = `ğŸ“… ${dateStr}`;
            	    detail.innerHTML = `<p>ë¯¸ì„¸ë¨¼ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            	  }

            	  // Collapse ì—´ê¸°
            	  const collapseEl = document.getElementById('collapseDust');
            	  const bsCollapse = new bootstrap.Collapse(collapseEl, {
            	    toggle: true
            	  });
            	});

            


            // ì¼ì • ìˆëŠ” ë‚ ì§œì— ë°°ê²½ìƒ‰ í‘œì‹œ
            const hasExam = examDates.find(exam => exam.date === dateStr);
            if (hasExam) {
              dayCircle.style.backgroundColor = "#f8d7da";
              dayCircle.title = hasExam.title;
            }

            cell.appendChild(dayCircle);
            day++;
          }

          row.appendChild(cell);
        }
        calendarBody.appendChild(row);
        if (day > lastDate) break;
      }
    }

    function changeMonth(step) {
      currentDate.setMonth(currentDate.getMonth() + step);
      renderCalendar(currentDate);
    }

    renderCalendar(currentDate);
  </script>
</body>
</html>
