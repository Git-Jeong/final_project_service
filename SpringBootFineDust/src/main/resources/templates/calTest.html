<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ë‹¬ë ¥ê³¼ ë¯¸ì„¸ë¨¼ì§€</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<style>
.day-circle {
	width: 30px;
	height: 30px;
	line-height: 30px;
	border-radius: 50%;
	margin: auto;
	cursor: pointer;
}

.calendar-box {
	border: 1px solid #ddd;
	padding: 15px;
	border-radius: 8px;
}

.schedule-card {
	border: 1px solid #ccc;
	border-radius: 10px;
}
</style>
</head>
<body>
	<div class="container my-5">
		<div class="row">
			<!-- ë‹¬ë ¥ ì˜ì—­ -->
			<div class="col-md-8 mb-4">
				<div class="calendar-box">
					<h4 class="d-flex align-items-center justify-content-between">
						<div>
							<button class="btn btn-outline-secondary btn-sm me-2"
								onclick="changeMonth(-1)">â†</button>
							<span id="month-year"></span>
							<button class="btn btn-outline-secondary btn-sm ms-2"
								onclick="changeMonth(1)">â†’</button>
						</div>
					</h4>
					<table class="table table-bordered mt-3 text-center">
						<thead>
							<tr>
								<th class="text-danger">ì¼</th>
								<th>ì›”</th>
								<th>í™”</th>
								<th>ìˆ˜</th>
								<th>ëª©</th>
								<th>ê¸ˆ</th>
								<th class="text-primary">í† </th>
							</tr>
						</thead>
						<tbody id="calendar-body"></tbody>
					</table>
				</div>
			</div>

			<!-- ğŸ“Œ ì¡°íšŒ + Collapse -->
			<div class="collapse" id="dustCard">
				<div class="col-md-4">
					<div class="card schedule-card">
						<div
							class="card-header d-flex justify-content-between align-items-center">
							<span>ë¯¸ì„¸ë¨¼ì§€ ì •ë³´ ì¡°íšŒ</span>
						</div>
						<div class="card-body" id="exam-schedule">
							<p>ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ ì•„ë˜ì— ë¯¸ì„¸ë¨¼ì§€ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
							<!-- Collapse ì˜ì—­ -->
							<div class="accordion" id="dustAccordion">
								<div class="accordion-item">
									<h2 class="accordion-header" id="headingDust">
										<button class="accordion-button collapsed" type="button"
											data-bs-toggle="collapse" data-bs-target="#collapseDust"
											aria-expanded="false" aria-controls="collapseDust">
											<span id="collapse-title">ë¯¸ì„¸ë¨¼ì§€ í‰ê·  ì •ë³´</span>
										</button>
									</h2>
									<div id="collapseDust" class="accordion-collapse collapse"
										aria-labelledby="headingDust">
										<div class="accordion-body" id="dust-detail">
											<p >ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ì˜¤ì „/ì˜¤í›„ í‰ê· ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
										</div>
									</div>
								</div>
							</div>

							<!-- ë -->
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Bootstrap JS -->
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<script>
    const calendarBody = document.getElementById("calendar-body");
    const monthYear = document.getElementById("month-year");
    let currentDate = new Date();

    
    

    function pad(num) {
      return String(num).padStart(2, "0");
    }
//ë‹¬ë ¥ ì†ëŒ€ì§€ë§ê²ƒ
    function renderCalendar(date) {
      calendarBody.innerHTML = "";
      const year = date.getFullYear();
      const month = date.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();
      monthYear.textContent = `${year}ë…„ ${month + 1}ì›”`;

      let day = 1;
      for (let i = 0; i < 6; i++) {
        const row = document.createElement("tr");
        for (let j = 0; j < 7; j++) {
          const cell = document.createElement("td"); //2ì¤‘ë°˜ë³µë¬¸ìœ¼ë¡œ í–‰ ì—´ ìƒì„± 

          if (i === 0 && j < firstDay || day > lastDate) {
            cell.innerHTML = "";
          } else {
            const thisDate = new Date(year, month, day);
            const dateStr = `${year}-${pad(month + 1)}-${pad(day)}`;
            const dayCircle = document.createElement("div");
            dayCircle.classList.add("day-circle");
            dayCircle.textContent = day;

            function getWeekdayName(dateStr) {
            	  const date = new Date(dateStr);
            	  const days = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
            	  return days[date.getDay()];
            	}   
            // ë‚ ì§œ í´ë¦­ ì´ë²¤íŠ¸
            dayCircle.addEventListener("click", () => {
            	//const dateStr = `${year}-${pad(month+1)}-${pad(day)}`; // í´ë¦­ëœ ë‚ ì§œ
            	
            	const weekday = getWeekdayName(dateStr);
            	  // 1. ë‚ ì§œ í´ë¦­ ì‹œ collapse ì¹´ë“œ ì—´ê¸°
            	  console.log("í´ë¦­ì€ë¨ ã…‡ã…‡ã…‡")
            	fetch(`/dust-data/${dateStr}`)	//ì„ íƒí•œ ë‚ ì§œ ë°ì´í„° ìš”ì²­
            	  .then(res => res.json())
            	  .then(data => {console.log(data)  // ë°›ì•„ì˜´ ã…‡ã…‡
            	    const title = document.getElementById("collapse-title");
            	    const detail = document.getElementById("dust-detail");
					
            	    title.textContent = `${dateStr} (${weekday}) ë¯¸ì„¸ë¨¼ì§€ í‰ê·  ì •ë³´`;
            	    console.log("error")

            	   if (!data || data.length === 0) {
        			detail.innerHTML = `<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
       				 return;
       				 
     				 }
                    const dustCard = document.getElementById("dustCard");
                    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(dustCard);
                    bsCollapse.show();  
                    // ã„´ ë“œëë‹¤ìš´ë³´ì—¬ì¤Œ 
                    detail.innerHTML = `<ul><li><strong>ì˜¤ì „ í‰ê· :</strong> PM1: ${data[0].amAvgPm1 ?? 'N/A'}, PM2.5: ${data[0].amAvgPm25 ?? 'N/A'}, PM10: ${data[0].amAvgPm10 ?? 'N/A'}</li><li><strong>ì˜¤í›„ í‰ê· :</strong> PM1: ${data[0].pmAvgPm1 ?? 'N/A'}, PM2.5: ${data[0].pmAvgPm25 ?? 'N/A'}, PM10: ${data[0].pmAvgPm10 ?? 'N/A'}</li></ul>`;
                    return;
					//period = HOUR(time_hms) <12 am or pm
            	    

            	      
            	    });
            	});

         

            cell.appendChild(dayCircle);
            day++;
          }

          row.appendChild(cell);
        }
        calendarBody.appendChild(row);
        if (day > lastDate) break;
      }
    }

    function average(arr) {
      return (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(2);
    }
	// ë‹¬(month) ì „í™˜ 
    function changeMonth(offset) {
      currentDate.setMonth(currentDate.getMonth() + offset);
      renderCalendar(currentDate);
    }

    renderCalendar(currentDate);
  </script>
</body>
</html>
