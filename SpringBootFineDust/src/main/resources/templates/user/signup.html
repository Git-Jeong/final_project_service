<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>회원가입</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
	rel="stylesheet" />
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<link rel="stylesheet" href="/css/user/SignupLogin.css" />
<link rel="stylesheet" href="/css/Common.css" />
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
/>
</head>

<body>
	<div class="signup-login-page-container">

		<!-- 우측 입력 폼 영역 -->
		<div>
			<form id="step1-form" method="post">
				<!-- Step 1 -->
				<div id="signup1" style="display: block" class="card-body text-black">
					<div class="signup-login-center-container">
						<div id="fixed-title" class="signup-login-head-title">
							<h3 class="signup-login-h3 mb-5">회원가입</h3>
						</div>
						<div class="signup-login-middle-content">
							<div class="mb-4"  id="email_input_box" style="display: block;">
								<div
									class="signup-login-form-label mb-2 d-flex align-items-center">
									<label for="usrEmail" class="me-1 mb-0">이메일</label> <span
										style="color: #FF0858;">*</span>
								</div>
								<div class="d-flex gap-3">
									<input placeholder="이메일을 입력하세요" type="text" id="usrEmail"
										name="usrEmail" required maxlength="30"
										title="영어, 숫자만 가능하며, 올바른 이메일 형식이어야 합니다."
										class="form-control form-control-lg signup-form-control" />
									<button id="idCheckTest" onclick="idCheck()" type="button"
										class="btn signup-login-btn-primary"
										style="white-space: nowrap;">이메일 인증</button>
								</div>
							</div>
							<div class="mb-4" id="email_code_check_box" style="display: none">
								<div
									class="signup-login-form-label mb-2 d-flex align-items-center">
									<label for="verificationCode" class="me-1 mb-0">인증코드</label> <span
										style="color: #FF0858;">*  </span><span id="codeTime" style="color: #FF0858;">유효시간 : </span>
								</div>
								<div class="d-flex gap-3">
									<input type="text" id="verificationCode" name="verificationCode"
										placeholder="이메일로 받은 인증 코드를 입력하세요" maxlength="6"
										class="form-control form-control-lg signup-form-control" />
									<button id="codeCheckTest" onclick="codeVerify()" type="button"
										class="btn signup-login-btn-primary"
										style="white-space: nowrap;">인증코드 확인</button>
								</div>
							</div>

							<div class="mb-4">
								<label class="signup-login-form-label mb-2" for="nick">
									닉네임 <span style="color: #FF0858;">*</span>
								</label><input placeholder="닉네임을 입력해주세요" type="text" id="usrNick"
									name="usrNick" maxlength="30" required="required"
									class="form-control form-control-lg signup-form-control"
									readonly="readonly" />
							</div>

							<div class="mb-4">
								<div class="signup-login-form-label mb-2">
									<label for="usrPw">비밀번호 (문자, 숫자, 특수문자 포함 8~20자)</label> <span
										style="color: #FF0858;">*</span>
								</div>
								<div class="d-flex gap-3">
									<div class="w-100">
										<input placeholder="비밀번호를 입력해주세요" type="password" id="usrPw"
											name="usrPw" maxlength="20" required="required"
											class="form-control form-control-lg signup-form-control"
											readonly="readonly" />
									</div>
									<div class="w-100">
										<input placeholder="비밀번호를 재입력해주세요" type="password"
											id="usrPwCheck" name="usrPwCheck" maxlength="20"
											required="required"
											class="form-control form-control-lg signup-form-control"
											readonly="readonly" />
									</div>
								</div>
							</div>
						</div>

						<div class="signup-login-bottom-content">
							<div align="center" title="이메일 중복체크를 해주세요." >
								<button type="button" id="goNextBtn" onclick="goNext()" 
								class="btn signup-login-next-btn btn-lg" 
								disabled>다음</button>
							</div>
							<div
								style="display: grid; grid-template-columns: 1fr 1fr; column-gap: 20px; row-gap: 1px; align-items: center; text-align: right; width: fit-content; margin: 0 auto;">
								<div>계정이 이미 있나요?</div>
								<div style="text-align: left;">
									<a style="font-weight: 600" href="login">로그인</a>
								</div>
								<div>비밀번호 잊으셨나요?</div>
								<div style="text-align: left;">
									<a style="font-weight: 600" href="resetpw">비밀번호 찾기</a>
								</div>
							</div>
						</div>
					</div>

				</div>
			</form>

			<!-- Step 2 -->
			<form id="step2-form">
				<div id="signup2" style="display: none"
					class="card-body p-md-5 text-black">

					<div class="signup-login-center-container">
						<div class="signup-login-head-title">

							<div id="fixed-title" class="signup-login-head-title">
								<h3 class="signup-login-h3 mb-5">지하철역 등록</h3>
							</div>
						</div>
						<div class="signup-login-middle-content">
							<div class="form-outline mb-4">
								<div
									class="signup-login-form-label mb-2 d-flex align-items-center">
									<label for="usrEmail" class="me-1 mb-0">지하철역 등록</label> <span
										style="color: #FF0858;">*</span>
								</div>
								<input placeholder="(필수)지하철역을 입력해주세요" type="text" id="stName_1"
									name="stName_1" maxlength="60" required="required"
									class="form-control form-control-lg signup-form-control" />
							</div>

							<div class="form-outline mb-4" id="insert-subway-2"
								style="visibility: hidden;">
								<label class="signup-login-form-label mb-2" for="subway2"></label>
								<input placeholder="(선택)지하철역을 입력해주세요" type="text" id="stName_2"
									name="stName_2" maxlength="60"
									class="form-control form-control-lg signup-form-control" />
							</div>

							<div class="form-outline mb-4" id="insert-subway-3"
								style="visibility: hidden;">
								<label class="signup-login-form-label mb-2" for="subway3"></label>
								<input placeholder="(선택)지하철역을 입력해주세요" type="text" id="stName_3"
									name="stName_3" maxlength="60"
									class="form-control form-control-lg signup-form-control" />
							</div>

							<div class="signup-login-btn-list-plus-minus">
							    <button type="button" id="plusButton" class="btn btn-plus" onclick="formPlus()">
							        <i class="fa fa-plus"></i>
							    </button>
							    <button type="button" id="minusButton" class="btn btn-minus" style="visibility: hidden;" onclick="formMinus()">
							        <i class="fa fa-minus"></i>
							    </button>
							</div>

							<div align="center">
								<button type="button" onclick="handleSubmit(event)"
									class="btn signup-login-next-btn btn-lg">회원가입</button>
							</div>
						</div>
						<div class="signup-login-bottom-content">
							<div
								style="display: grid; grid-template-columns: 1fr 1fr; column-gap: 20px; row-gap: 1px; align-items: center; text-align: right; width: fit-content; margin: 0 auto;">
								<div>계정이 이미 있나요?</div>
								<div style="text-align: left;">
									<a style="font-weight: 600" href="login">로그인</a>
								</div>
								<div>비밀번호 잊으셨나요?</div>
								<div style="text-align: left;">
									<a style="font-weight: 600" href="resetpw">비밀번호 찾기</a>
								</div>
							</div>
						</div>
					</div>



				</div>
			</form>
		</div>
		<!-- col-md-6 -->

	</div>
	<!-- signup-page-container -->

	<script>
		let subwayIndex = 1;
		let idCheckPassed = false;
		
		function updateButtons() {
		    document.getElementById("minusButton").style.visibility = subwayIndex === 1 ? "hidden" : "visible";
		    document.getElementById("plusButton").style.visibility = subwayIndex === 3 ? "hidden" : "visible";
		}
		
		function formPlus() {
			if (subwayIndex < 3) {
				subwayIndex++;
				document.getElementById(`insert-subway-${subwayIndex}`).style.visibility = "visible";
				updateButtons();
			}
		}

		function formMinus() {
			if (subwayIndex > 1) {
				document.getElementById(`insert-subway-${subwayIndex}`).style.visibility = "hidden";
				subwayIndex--;
				updateButtons();
			}
		}

		let countdownInterval;
		const startCountdown = (duration) => {
		  clearInterval(countdownInterval);
		  let timeLeft = duration;

		  const updateTimer = () => {
		    const minutes = Math.floor(timeLeft / 60);
		    const seconds = timeLeft % 60;
		    const formatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;
		    document.getElementById('codeTime').textContent = `유효시간 : ${formatted}`;

		    if (timeLeft <= 0) {
		      clearInterval(countdownInterval);
		      alert('인증 시간이 만료되었습니다. 다시 시도해 주세요.');

		      $('#email_code_check_box').hide();
		      $('#email_input_box').show();
		      $('#usrEmail').prop('readonly', false);
		      document.getElementById("idCheckTest").removeAttribute("disabled");
		      document.getElementById("idCheckTest").classList.remove("disabled");

		      
		      //window.location.href = '/signup';
		      return;
		    }
		    timeLeft--;
		  };

		  updateTimer();
		  countdownInterval = setInterval(updateTimer, 1000);
		}

		const codeVerify = () =>{
			const usrEmail = $('#usrEmail').val();
			const code = $('#verificationCode').val();

			if (!code) {
				alert("인증 코드를 입력해 주세요.");
				return;
			}

			$.ajax({
				type : "POST",
				url : "/verify-code",
				data : {
					usrEmail : usrEmail,
					code : code
				},
				success : function(response) {
					clearInterval(countdownInterval);
					alert("인증 성공");
					idCheckPassed = true; 
					document.getElementById("codeCheckTest").disabled = true;
				    document.getElementById("email_code_check_box").style.display = "none";
				    document.getElementById("email_input_box").style.display = "block";
					document.getElementById("goNextBtn").disabled = false;
					document.querySelector('#goNextBtn').parentElement.removeAttribute('title');
					document.getElementById("usrNick").readOnly = false;
					document.getElementById("usrPw").readOnly = false;
					document.getElementById("usrPwCheck").readOnly = false; 
				},
				error : function(xhr) {
					if (xhr.status === 400) {
						alert("인증 실패: 인증 코드가 올바르지 않습니다.");
					} else {
						alert("서버 오류: " + xhr.statusText);
					}
				}
			});
		}
		const idCheck = () => {
			const usrEmail = $('#usrEmail').val();
			if (!usrEmail) {
				alert("이메일을 입력해 주세요.");
				return;
			}

			if (usrEmail.length > 30) {
				alert("이메일은 30자 이하로 입력해 주세요.");
				return;
			}

			const emailPattern = /^[0-9A-Za-z._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z0-9-]{1,}$/;
			if (!emailPattern.test(usrEmail)) {
				alert("올바른 이메일 형식이 아닙니다.");
				return;
			}

			const $btn = $('#idCheckTest');
			const originalHTML = $btn.html();
			$btn.data('original-html', originalHTML);
			$btn.prop('disabled', true).addClass('disabled');
			$btn.html('<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>전송 중...');
			$('#usrEmail').prop('readonly', true);

			$.ajax({
				type: "POST",
				url: "/new-send-code",
				contentType: "application/json",
				data: JSON.stringify({ "usrEmail": usrEmail }),
				dataType: "text",
				success: function (responseText) {
					const response = JSON.parse(responseText);
					if (response.status === "success") {
						startCountdown(response.codeValidSeconds); 
						alert("인증 코드가 이메일로 전송되었습니다.");
						$('#email_code_check_box').show();
						$('#email_input_box').hide();
					} else if (response.status === "fail") {
						alert("중복된 계정입니다.");
						$('#usrEmail').prop('readonly', false);
					}
				},
				error: function () {
					alert("에러가 발생했습니다.");
					$('#usrEmail').prop('readonly', false);
				},
				complete: function () {
					// 성공 시에는 버튼 비활성 유지, 실패 시에만 복구
					if ($('#email_input_box').is(':visible')) {
						$btn.prop('disabled', false).removeClass('disabled');
					}
					$btn.html($btn.data('original-html'));
				}
			});
		}

		function goNext() {

			const usrEmail = $('#usrEmail').val();
			const usrNick = $('#usrNick').val();
			const usrPw = $('#usrPw').val();
			const usrPwCheck = $('#usrPwCheck').val();

			if (!idCheckPassed) {
				alert("이메일 중복체크를 해주세요.");
				return;
			}

			if (!usrEmail) {
				alert("이메일을 입력해 주세요.");
				return;
			}

			if (!usrNick) {
				alert("닉네임을 입력해 주세요.");
				return;
			}

			if (!usrPw) {
				alert("비밀번호를 입력해 주세요.");
				return;
			}

			if (!usrPwCheck) {
				alert("비밀번호 확인을 입력해 주세요.");
				return;
			}

			// 잘못된 조건 수정
			if ((usrPw.length < 8) || (usrPw.length > 20)) {
				alert("비밀번호는 8~20자로 입력해 주세요.");
				return;
			}

			if (usrPw != usrPwCheck) {
				alert("비밀번호가 일치하지 않습니다.");
				return;
			}

			$("#signup1").hide();
			$("#signup2").show();
		}

		function handleSubmit(event) {
			if (!confirm('회원가입을 진행하시겠습니까?? ')) {
				return;
			}

			event.preventDefault();

			const stName_1 = $('#stName_1').val();
			const usrEmail = $('#usrEmail').val();
			const usrNick = $('#usrNick').val();
			const usrPw = $('#usrPw').val();
			const usrPwCheck = $('#usrPwCheck').val();

			if (!stName_1) {
				alert("역을 하나는 입력해 주세요.");
				return;
			}

			$.ajax({
				type : "POST",
				url : "/signup",
				contentType : "application/json",
				data : JSON.stringify({
					"usrEmail" : usrEmail,
					"usrNick" : usrNick,
					"usrPw" : usrPw
				}),
				dataType : "text",
				success : function(response) {
					if (response === 'success') {
						insertStationList(usrEmail);
					} else {
						alert("회원정보 생성 실패: " + response);
					}
				},
				error : function(xhr, status, error) {
					alert("서버 오류: " + error);
				}
			});
		}
		
		const insertStationList = (usrEmail) =>{ 
			$('#step2-form').append($('<input>').attr({
				type : 'hidden',
				name : 'usrEmail',
				value : usrEmail
			}))

			const stName_1 = $('#stName_1').val();
			const stName_2 = $('#stName_2').val();
			const stName_3 = $('#stName_3').val();
			
			
		}
	</script>
</body>
</html>
